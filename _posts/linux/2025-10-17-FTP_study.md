---
layout: post
title: "FTP"
date: 2025-10-17 17:30:00 +0900
categories: [linux]
---

## 1. 개요

**FTP (File Transfer Protocol)**는 서버와 클라이언트 간에 파일을 전송하기 위해 설계된 표준 통신 프로토콜이다.
대용량 파일 전송에 유리하고 구조가 단순하여 오랫동안 사용되어 왔으나, 데이터를 암호화하지 않고 **평문(Plain Text)으로 전송**하기 때문에 보안에 취약하다는 단점이 있다.

### 핵심 특징
1.  **전송 모드**: 데이터 연결 방식에 따라 Active 모드와 Passive 모드로 나뉜다.
2.  **보안 문제**: 아이디, 비밀번호, 파일 내용이 네트워크 상에 그대로 노출되므로, 보안이 중요한 환경에서는 **SFTP** (SSH 기반)나 **FTPS** (SSL/TLS 기반)를 사용해야 한다.
3.  **접속 방식**: 명령 제어 포트(21번)와 데이터 전송 포트(20번 또는 랜덤 포트)를 별도로 사용한다.

### 접속 모드 비교 (Active vs Passive)
| 모드 | 연결 주체 (데이터) | 방화벽 이슈 | 권장 환경 |
|------|---|---|---|
| **Active Mode** | 서버 → 클라이언트 | 클라이언트 방화벽이 서버의 접속을 차단할 수 있음 | 잘 사용하지 않음 |
| **Passive Mode** | 클라이언트 → 서버 | 서버 방화벽에서 포트 범위를 열어줘야 함 | **대부분의 환경에서 권장** |

---

## 2. 서버 구축 (vsftpd)

리눅스 환경에서 보안성과 성능이 우수한 `vsftpd` (Very Secure FTP Daemon)를 설치하고 설정하는 과정이다.

### 설치 및 실행
```bash
# 패키지 설치
dnf install -y vsftpd

# 서비스 시작 및 부팅 시 자동 실행
systemctl enable --now vsftpd

# 방화벽 허용 (FTP 서비스)
firewall-cmd --permanent --add-service=ftp
firewall-cmd --reload
```

### 보안 설정 (/etc/vsftpd/vsftpd.conf)
익명 접속을 차단하고 로컬 사용자만 허용하며, 사용자가 자신의 홈 디렉터리 상위로 이동하지 못하도록 제한(Chroot)하는 것이 필수적이다.

```ini
# 익명 사용자 접속 차단 (보안 필수)
anonymous_enable=NO

# 로컬 시스템 사용자 계정 접속 허용
local_enable=YES

# 파일 업로드(쓰기) 허용
write_enable=YES

# Chroot 설정: 사용자를 자신의 홈 디렉터리에 가둠
chroot_local_user=YES
allow_writeable_chroot=YES
```
설정 변경 후 반드시 서비스를 재시작한다: `systemctl restart vsftpd`

---

## 3. 사용자 및 권한 관리

FTP 전용 계정을 생성하고 SELinux 설정을 통해 접근 권한을 부여한다.

### 사용자 생성
```bash
# FTP 전용 계정 생성
useradd ftpuser
passwd ftpuser

# 홈 디렉터리 확인
ls -ld /home/ftpuser
```

### SELinux 설정
SELinux가 활성화된 시스템에서는 FTP 데몬이 사용자 홈 디렉터리에 접근하는 것을 차단할 수 있다. 이를 허용해주어야 한다.
```bash
# 홈 디렉터리 읽기/쓰기 권한 허용
setsebool -P tftp_home_dir 1

# 또는 FTP 전체 접근 허용 (주의)
setsebool -P ftpd_full_access 1
```

---

## 4. 실습: 로그 분석

FTP 파일 전송 기록은 기본적으로 `/var/log/xferlog`에 저장된다. 이를 분석하여 파일 유출이나 비인가 업로드를 추적할 수 있다.

### 로그 형식 분석 (xferlog)
```text
Thu Oct 21 14:20:30 2025 1 10.0.0.1 1024 /home/user/file.txt b _ i r ftpuser ftp 0 * c
```
*   **전송 방향**: `i` (Incoming, 업로드), `o` (Outgoing, 다운로드)
*   **파일명**: `/home/user/file.txt` (전송된 파일 경로)
*   **사용자**: `ftpuser` (전송을 수행한 계정)
*   **완료 여부**: `c` (Complete, 성공), `i` (Incomplete, 실패/중단)

### 로그 검색 예시
```bash
# 업로드된 파일(Incoming) 목록 검색
grep " i r " /var/log/xferlog

# 다운로드된 파일(Outgoing) 목록 검색
grep " o r " /var/log/xferlog

# 전송 실패 기록 검색
grep " i$" /var/log/xferlog
```

---

## 5. 보안 주의사항

FTP는 설계상 보안에 취약하므로 운영 시 주의해야 할 사항들이다.

### 평문 전송 위험
FTP는 **아이디, 비밀번호, 파일 내용 모두 암호화 없이 전송**된다. 네트워크 스니핑(Wireshark 등)으로 쉽게 도청될 수 있다.
*   **대안**: 보안이 필요한 환경에서는 **SFTP (SSH FTP)** 또는 **FTPS (FTP over TLS)**를 사용해야 한다.

### Anonymous FTP 위험
익명 접속(`anonymous_enable=YES`)을 허용하면 누구나 파일을 다운로드하거나 업로드할 수 있어 **악성코드 배포 서버로 악용**될 수 있다.
```ini
# vsftpd.conf (필수 설정)
anonymous_enable=NO
```

### FTP Bounce Attack
공격자가 FTP 서버의 `PORT` 명령을 악용하여 **제3의 시스템을 포트 스캔**하거나 방화벽을 우회할 수 있다. Passive 모드를 강제하고 PORT 명령을 제한해야 한다.
```ini
# vsftpd.conf
pasv_enable=YES
port_enable=NO
```

### Chroot 필수
사용자가 자신의 홈 디렉터리 상위(`/etc`, `/var` 등)를 탐색하지 못하도록 **Chroot Jail**을 반드시 설정한다.
```ini
chroot_local_user=YES
allow_writeable_chroot=YES
```

<hr class="short-rule">
