---
layout: post
title: "Azure CLI??용???이브리???라?드 보안 ?키?처 구축"
date: 2025-09-26 17:00:00 +0900
categories: [security-solutions]
---

### Azure CLI?구축???이브리???라?드 보안 ?키?처

???로?트??Azure CLI??용???프???? ?라?드??전?게 ?결?는 ?이브리???트?크?구축?는 과정?니?? ?제 기업 ?경??가?하??**Site-to-Site VPN**?**BGP 기반 ?적 ?우??*?로 견고???결?을 ?보?고, **Ansible**???해 구성 관리? ?동?했?니?? ?한, **NSG ?책**??조합?여 ?트?크 ???서부??**?층 방어(Defense in Depth)**? **최소 권한 ?칙(Principle of Least Privilege)**??구현?는 ??중점???었?니??

---

### 1. ?체 ?키?처 개요

??키?처??On-prem ???이???경?Azure ?라?드 ?경?로 구성?니?? ?히 On-prem???어 ?드가 VPN???해 Azure ????관??드?을 ?어?고, ??어??NSG??해 ?격?게 격리?는 구조?니??

![?키?처 ?이?그??(/assets/images/security-architecture/Hybrid_1.png)

*   ***?프???????이??VNet***: `192.168.0.0/16`
    -   **?어 ?드(Ansible Controller)**: Azure VM?의 구성???동?하??컨트?????????행?니??
*   ***Azure ?라?드 VNet***: `10.42.0.0/16`
    -   **Web Tier (`10.42.10.0/24`)**: ?? ?청??처리?는 ???버 ?역?니??
    -   **DB Tier (`10.42.20.0/24`)**: ?? ?이?? ??하???이?베?스 ?버 ?역?니??
    -   **Monitoring Tier (`10.42.30.0/24`)**: 중앙 로깅 ?모니?링???한 ELK Stack ?버 ?역?니??
*   ***?결 방식***: **Route-based VPN Gateway + BGP**
    -   IPsec 기반 ?호???널???해 ?신 ?이?? 보호?니??
    -   BGP??해 ?쪽 ?트?크??경로 ?보??적?로 교환?여 관리의 ?율?과 ?장?을 ?보?니??
*   ***보안 ?책***: **NSG (Network Security Group)**
    -   ??어(Web, DB, Monitoring) ?에 L4 가??방화벽을 배치?여, ?????래?만 ?과?키??최소 권한 ?칙???용?니??
    -   **Web-NSG**: On-Prem ??Web (80, 443, 22), ???모든 ?바?드 차단.
    -   **DB-NSG**: Web Tier ??DB (3306), On-Prem ??DB (22), ???모든 ?바?드 차단.
    -   **ELK-NSG**: On-Prem ??Kibana (5601), Web/DB Tier ??Logstash (5044), On-Prem ??ELK (22).

---

### 2. ?경 구축 ?차

??계??Azure CLI 명령?? ?해 진행?으? 모든 리소???름?는 ???을 ?해 `st421-` ?두?? ?용?습?다.

#### ***1. 리소??그룹 ?VNet ?성***

On-prem?Azure ?경???리?으?분리?기 ?해 별도??리소??그룹???성?니?? ??경??VNet??브?을 ?계??맞게 구성?니?? ?히 모니?링 ?어??한 ?브??`st421-subnet-monitoring`)??추???성?여 ????분리?습?다.

![리소??그룹 ?성 결과 ?면](/assets/images/security-architecture/Hybrid_2.png)

```bash
# 리소??그룹 ?성
az group create --name st421-rg-onprem --location koreacentral
az group create --name st421-rg-azure --location koreacentral

# On-prem VNet ??브???성
az network vnet create -g st421-rg-onprem -n st421-vnet-onprem --address-prefix 192.168.0.0/16 --subnet-name st421-subnet-client --subnet-prefix 192.168.10.0/24
az network vnet subnet create -g st421-rg-onprem --vnet-name st421-vnet-onprem -n GatewaySubnet --address-prefix 192.168.254.0/27

# Azure VNet ??브???성
az network vnet create -g st421-rg-azure -n st421-vnet-azure --address-prefix 10.42.0.0/16
az network vnet subnet create -g st421-rg-azure --vnet-name st421-vnet-azure -n GatewaySubnet --address-prefix 10.42.254.0/27
az network vnet subnet create -g st421-rg-azure --vnet-name st421-vnet-azure -n st421-subnet-web --address-prefix 10.42.10.0/24
az network vnet subnet create -g st421-rg-azure --vnet-name st421-vnet-azure -n st421-subnet-db --address-prefix 10.42.20.0/24
az network vnet subnet create -g st421-rg-azure --vnet-name st421-vnet-azure -n st421-subnet-monitoring --address-prefix 10.42.30.0/24
```

#### ***2. BGP ?성??VPN Gateway ??결 구성***

?적 ?우??Static Routing)??리 BGP ?적 ?우?을 ?용?는 ?유??**?장?과 관??율??* ?문?니?? ?후 On-prem?나 ?라?드???로???브?이 추???경우, BGP가 ?동?로 경로??습?고 ?파????동?로 ?우???이블을 ?정???요가 ?습?다.

??과정?서 가??중요????, Local Network Gateway ?성 ??**???게이?웨?의 BGP ?어?IP 주소(`--bgp-peering-address`)**?명확??지?해주는 것입?다. ?는 게이?웨?? BGP ?신???해 ???으??용?는 Private IP? VNet Gateway ?성 ???적?로 조회?여 ?정?야 ?니??

```bash
# 1. 공인 IP ?성
az network public-ip create -g st421-rg-onprem -n st421-pip-onprem --sku Standard
az network public-ip create -g st421-rg-azure -n st421-pip-azure --sku Standard

# 2. VNet Gateway ?성
az network vnet-gateway create -g st421-rg-onprem -n st421-vng-onprem --public-ip-address st421-pip-onprem --vnet st421-vnet-onprem --gateway-type Vpn --vpn-type RouteBased --sku VpnGw3 --asn 65501
az network vnet-gateway create -g st421-rg-azure -n st421-vng-azure --public-ip-address st421-pip-azure --vnet st421-vnet-azure --gateway-type Vpn --vpn-type RouteBased --sku VpnGw3 --asn 65502

# 3. ?게이?웨?의 BGP ?어?IP 조회
ONPREM_BGP_IP=$(az network vnet-gateway show -g st421-rg-onprem -n st421-vng-onprem --query "bgpSettings.bgpPeeringAddress" -o tsv)
AZURE_BGP_IP=$(az network vnet-gateway show -g st421-rg-azure -n st421-vng-azure --query "bgpSettings.bgpPeeringAddress" -o tsv)

# 4. 공인 IP 조회
ONPREM_GW_IP=$(az network public-ip show -g st421-rg-onprem -n st421-pip-onprem --query ipAddress -o tsv)
AZURE_GW_IP=$(az network public-ip show -g st421-rg-azure -n st421-pip-azure --query ipAddress -o tsv)

# 5. BGP ?어?IP?지?하??Local Network Gateway ?성
az network local-gateway create -g st421-rg-azure -n st421-lng-onprem --gateway-ip-address $ONPREM_GW_IP --local-address-prefixes "192.168.0.0/16" --asn 65501 --bgp-peering-address $ONPREM_BGP_IP
az network local-gateway create -g st421-rg-onprem -n st421-lng-azure --gateway-ip-address $AZURE_GW_IP --local-address-prefixes "10.42.0.0/16" --asn 65502 --bgp-peering-address $AZURE_BGP_IP

# 6. VPN ?결 ?성
SHARED_KEY="YourSecureSharedKey"
az network vpn-connection create -g st421-rg-azure -n st421-conn-azure-to-onprem --vnet-gateway1 st421-vng-azure --local-gateway2 st421-lng-onprem --shared-key "$SHARED_KEY" --enable-bgp
az network vpn-connection create -g st421-rg-onprem -n st421-conn-onprem-to-azure --vnet-gateway1 st421-vng-onprem --local-gateway2 st421-lng-azure --shared-key "$SHARED_KEY" --enable-bgp
```

#### ***3. NSG ?책 ?용***

NSG???트?크 ???서 **최소 권한 ?칙??구현?는 ?심 ?소**?니?? 기본?으?모든 ?바?드 ?래?을 차단?고, ??어??????맞는 최소?의 ?래?만 명시?으??용?는 '?이?리?트' 방식?로 보안??강화?니??

?? ?어, DB ?어???직 Web ?어로??의 MySQL(3306) ?래?과 관?목적?로 On-Prem ?어 ?드로??의 SSH(22) ?래?만 ?용?니?? ???의 모든 ?근? 차단?어, On-Prem???반 ?용?? DB??직접 ?근?는 것을 ?천?으?막습?다.

```bash
# DB ?버??NSG ?성 ?규칙 ?정
az network nsg create -g st421-rg-azure -n st421-nsg-db
az network nsg rule create -g st421-rg-azure --nsg-name st421-nsg-db -n "Allow-MySQL-From-Web" --priority 100 --source-address-prefixes "10.42.10.0/24" --destination-port-ranges 3306 --access Allow --protocol Tcp
az network nsg rule create -g st421-rg-azure --nsg-name st421-nsg-db -n "Allow-SSH-From-OnPrem" --priority 110 --source-address-prefixes "192.168.0.0/16" --destination-port-ranges 22 --access Allow --protocol Tcp
```

![DB ?어 NSG 규칙 ?정 ?면](/assets/images/security-architecture/Hybrid_3.png)

#### ***4. VM 배포 ?Ansible???용??구성 ?동??**

Ansible?같? 구성 관??구??용?는 목적? **???과 반복???보**?니?? ?동?로 ?버??정????발생?????는 ?수?방??고, 모든 ?버가 코드(?레?북)???의???일???태????도?보장?니??멱등??. ?는 보안 ?정 ?락?같? 리스?? ?게 줄여줍니??

On-prem ?어 ?드?서 Ansible ?레?북???행?여 ??버???????의?고 ?요???프?웨?? ?치 ??정?니??
*   **Web ?버 ?레?북 (`web-playbook.yml`)**: `httpd` ?키지??치?고 ?비?? ?성?하? 기본 ???이지?배포?니??
*   **DB ?버 ?레?북 (`db-playbook.yml`)**: `mariadb-server`??치?고, ?이?베?스 ??용?? ?성?니??
*   **ELK ?버 ?레?북 (`elk-playbook.yml`)**: `Elasticsearch`? `Kibana`??치?고, ???서 ?속?????도??정??변경한 ???비?? ?성?합?다.

```yaml
# DB ?버 ?레?북 ?시 (db-playbook.yml)
---
- hosts: db
  become: yes
  tasks:
    - name: Install MariaDB and PyMySQL
      dnf:
        name: ['mariadb-server', 'python3-PyMySQL']
        state: present
    - name: Start and enable mariadb service
      service:
        name: mariadb
        state: started
        enabled: yes
```

---

### 3. 검?결과

구축???키?처가 ?도???작?는지 검증을 진행?니?? 모든 검증? **On-Prem ?어 ?드(`192.168.10.4`)** ?서 ?행?습?다.

#### ***1. On-Prem ??Web ?버 ?속***

VPN?BGP ?우?이 ?상?으??작?는지, 그리?Web ?어 NSG ?책???바른? ?인?기 ?해 `curl` 명령?로 ???버???속?니??

```bash
# On-Prem ?어 ?드?서 ?행
curl http://10.42.10.4
```

![On-Prem VM?서 Web ?버??속 ?공??결과 ?면](/assets/images/security-architecture/Hybrid_4.png)

> Ansible ?레?북?로 배포???영 메시지가 ?상?으??신?었?니?? ?? ?해 On-Prem?서 Azure ?? Private IP로의 ?신???활?을 ?인?습?다.

#### ***2. On-Prem ??DB ?버 직접 ?속 차단***

최소 권한 ?칙?????용?었?? ?인?기 ?해, ?용?? ?? 경로??On-Prem?서 DB ?버?직접 ?속???도?니??

```bash
# On-Prem ?어 ?드?서 ?행
mysql -u webuser -p'WebPass123!' -h 10.42.20.4 --connect-timeout=5
```

![On-Prem VM?서 DB ?버??속 ?패??결과 ?면](/assets/images/security-architecture/Hybrid_5.png)

> ?상???속??차단?었?니?? ???패??DB ?어??NSG가 ?계???작?고 ?음??증명?니??

#### ***3. BGP ?적 ?우???태 검?**

Azure CLI??해 BGP ?어??태??인?니?? `Connected` ?태? `RoutesReceived` 값을 ?해 ?적 ?우?이 ?공?으??립?었?을 객??인 ?이?로 검증할 ???습?다.

```bash
az network vnet-gateway list-bgp-peer-status -g st421-rg-azure -n st421-vng-azure -o table
```

![BGP ?어??태가 Connected??인???면](/assets/images/security-architecture/Hybrid_6.png)

---

### 4. 마무?

?번 ?로?트??해 BGP 기반???적 ?우?을 ?용???이브리???라?드 ?트?크?구축?고, Ansible???용??구성 관리? ?동?하????과정??경험?????었?니?? ?히, Local Network Gateway ?정 ??BGP ?어?주소?명시?는 것의 중요?과 NSG??한 ?어 ??근 ?어가 보안 ?키?처???심?을 ?해?는 ?? ?는 과정?었?니??

<hr class="short-rule">