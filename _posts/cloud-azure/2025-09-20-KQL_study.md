---
layout: post
title: "KQL 공부: 클라우드 보안 로그 분석"
date: 2025-09-20 17:00:00 +0900
categories: [cloud-azure]
tags: [KQL, Azure Sentinel, Threat Hunting, Log Analysis, SIEM]
description: "Azure Sentinel 및 Monitor에서 사용하는 KQL(Kusto Query Language) 문법과 위협 헌팅 실습"
---

## 1. 개요

**KQL (Kusto Query Language)**은 Microsoft Azure 환경의 방대한 로그 데이터에서 특정 정보를 검색하고 분석하기 위한 강력한 쿼리 언어입니다.
Azure Sentinel(SIEM), Azure Monitor, Microsoft Defender for Endpoint 등 다양한 보안 솔루션에서 사용되며, 보안 분석가가 침해 흔적을 찾거나 위협을 헌팅할 때 필수적으로 다뤄야 하는 기술입니다.

---

## 2. 기본 문법 및 구조

KQL은 파이프(`|`)를 사용하여 데이터 흐름을 제어합니다. SQL과 유사하지만 더 직관적이고 데이터 분석에 최적화되어 있습니다.

```kql
[테이블 이름]
| [필터링 연산자]
| [가공 연산자]
| [정렬/출력 연산자]
```

### 주요 연산자
*   **`where`**: 조건에 맞는 행을 필터링합니다. (예: `where TimeGenerated > ago(1d)`)
*   **`project`**: 원하는 열만 선택하여 출력합니다.
*   **`summarize`**: 데이터를 그룹화하고 집계합니다. (`count()`, `dcount()`, `avg()` 등 사용)
*   **`extend`**: 계산된 값을 새로운 열로 추가합니다.
*   **`join`**: 두 테이블의 데이터를 결합합니다.
*   **`render`**: 결과를 차트나 그래프로 시각화합니다.

---

## 3. 실습: RDP 무차별 대입 공격 탐지

외부에서 들어오는 RDP(3389) 접속 시도가 급증하는 패턴을 찾아내는 위협 헌팅 시나리오입니다.

### 3.1. 실패한 로그인 시도 집계
`SecurityEvent` 테이블에서 이벤트 ID `4625`(로그인 실패)를 필터링하고, IP 주소별로 실패 횟수를 집계합니다.

```kql
SecurityEvent
| where EventID == 4625
| where TimeGenerated > ago(1h)
| summarize FailureCount = count() by IpAddress
| where FailureCount > 10
| order by FailureCount desc
```

### 3.2. 시각화 (TimeChart)
로그인 실패 추이를 시간대별로 시각화하여 공격이 발생한 시점을 파악합니다.

```kql
SecurityEvent
| where EventID == 4625
| summarize count() by bin(TimeGenerated, 5m)
| render timechart
```

   ![KQL_Query](/assets/images/system-hacking/KQL_Query.png)

---

## 4. 심화: Join을 이용한 상관 분석

로그인 실패가 많았던 IP가 결국 로그인에 성공했는지 확인하려면 `join`을 사용해야 합니다.

```kql
let FailedLogins = SecurityEvent
| where EventID == 4625
| summarize FailureCount = count() by IpAddress, Account;

let SuccessfulLogins = SecurityEvent
| where EventID == 4624
| project IpAddress, Account, TimeGenerated;

FailedLogins
| join kind=inner (SuccessfulLogins) on IpAddress, Account
| project IpAddress, Account, FailureCount, TimeGenerated
```
이 쿼리는 "반복적으로 실패하다가 결국 성공한" 의심스러운 접속을 찾아냅니다.

---

## 5. 보안 관점에서의 활용

*   **위협 헌팅 (Threat Hunting)**: 알려진 공격 패턴(시그니처)에 의존하지 않고, 가설을 세워 능동적으로 이상 징후를 탐색합니다.
*   **사고 대응 (Incident Response)**: 침해 사고 발생 시, 공격자의 이동 경로, 실행한 명령어, 접근한 파일 등을 타임라인으로 재구성하여 피해 범위를 산정합니다.
*   **자동화 규칙 (Analytics Rule)**: 특정 KQL 쿼리 조건이 충족되면 자동으로 경보(Alert)를 생성하고 대응(Playbook)을 실행하도록 설정할 수 있습니다.

<hr class="short-rule">
