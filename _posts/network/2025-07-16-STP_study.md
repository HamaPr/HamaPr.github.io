---
layout: post
title: "STP"
date: 2025-07-16 17:00:00 +0900
categories: [network]
---

## 1. 개요

**STP (Spanning Tree Protocol)**는 스위치 이중화 구성 시 필연적으로 발생하는 **L2 브로드캐스트 루프(Loop)**를 방지하기 위한 프로토콜(IEEE 802.1D)이다.
네트워크의 신뢰성을 위해 물리적으로는 경로를 이중화(Redundancy)하되, 논리적으로는 하나의 경로만 활성화하고 나머지는 차단(Blocking)하여 루프 없는 트리 구조를 만든다.

### 루프의 위험성
STP가 없다면 브로드캐스트 프레임이 스위치 간을 무한히 순환하며 대역폭을 고갈시키는 **브로드캐스트 스톰(Broadcast Storm)**이 발생하여 전체 네트워크가 마비된다.

### STP 버전 비교
| 버전 | 표준 | 수렴 시간 | 특징 |
|---|---|---|---|
| **STP (CST)** | 802.1D | 30~50초 | 가장 기본, VLAN 통합 관리 |
| **RSTP** | 802.1w | 1~5초 | 빠른 수렴 속도 |
| **PVST+** | Cisco | 30~50초 | VLAN별 별도 STP (Cisco 기본) |
| **Rapid PVST+** | Cisco | 1~5초 | VLAN별 RSTP |
| **MST** | 802.1s | 빠름 | 여러 VLAN을 그룹으로 묶어 관리 |

---

## 2. 동작 원리 (선출 과정)

STP는 **BPDU (Bridge Protocol Data Unit)**라는 프레임을 교환하여 트리를 구성한다.

```mermaid
flowchart TD
    Rule1[1. Root Bridge 선출<br>모든 스위치 중 하나]
    Rule2[2. Root Port 선출<br>Root Bridge가 아닌 스위치마다 하나]
    Rule3[3. Designated Port 선출<br>세그먼트(링크)마다 하나]
    Rule4[4. Blocked Port<br>나머지 포트 차단]
    Rule1 --> Rule2 --> Rule3 --> Rule4
```

### Bridge ID (BID)
선출의 기준이 되는 값으로, `Priority(2byte)` + `MAC Address(6byte)`로 구성된다.
값이 **낮을수록 우선순위가 높다**(Root가 된다).
*   **기본 Priority**: 32768 (VLAN ID에 따라 32769 등으로 표시됨)

### 포트 상태 변화 (State)
| 상태 | 설명 | 소요 시간 |
|---|---|---|
| **Blocking** | 데이터 전송 불가, BPDU 수신만 가능 | 20초 (Max Age) |
| **Listening** | 루프 감지, BPDU 송수신 | 15초 (Forward Delay) |
| **Learning** | MAC 주소 학습 시작 | 15초 (Forward Delay) |
| **Forwarding** | 데이터 정상 전송 | - |
| **Disabled** | 포트가 꺼져 있거나 케이블 분리 | - |

---

## 3. 설정 방법 (Cisco)

### 1. Root Bridge 고정
특정 코어 스위치를 Root Bridge로 지정하여 경로를 최적화한다. Priority를 낮추면 된다.
```cisco
! 방법 1: Priority 직접 지정 (4096 단위)
Switch(config)# spanning-tree vlan 1 priority 4096

! 방법 2: 매크로 사용 (Primary는 24576, Secondary는 28672)
Switch(config)# spanning-tree vlan 1 root primary
```

### 2. PortFast 설정 (엣지 포트 최적화)
PC나 서버 등 종단 장비가 연결된 포트는 루프 험이 없으므로, STP 계산 없이 즉시 **Forwarding** 상태가 되도록 설정한다. (30초 대기 시간 제거)
```cisco
Switch(config)# interface fa0/1
Switch(config-if)# spanning-tree portfast
```

### 3. BPDU Guard (보안)
PortFast가 설정된 포트에 실수로 스위치가 연결되어 BPDU가 수신되면, 루프 방지를 위해 해당 포트르 즉시 셧다운(Shutdown) 시킨다.
```cisco
Switch(config-if)# spanning-tree bpduguard enable
```

### 4. 고속 STP 모드 변경 (Rapid PVST+)
```cisco
Switch(config)# spanning-tree mode rapid-pvst
```

---

## 4. 확인 및 트러블슈팅

### STP 상태 확인
```cisco
Switch# show spanning-tree
! 현재 Root Bridge가 누구인지, 내 포트 상태(BLK/FWD)가 무엇인지 확인

Switch# show spanning-tree vlan 10
! 특정 VLAN의 트리 정보 확인
```

### 출력 예시 분석
```text
VLAN0001
  Spanning tree enabled protocol ieee
  Root ID    Priority    32769
             Address     0001.42A1.2345
             This bridge is the root  <-- 내가 대장(Root)임
```

### 문제 해결: BPDU Guard로 인한 포트 셧다운
`err-disable` 상태가 된 포트를 복구한다.
```cisco
! 수동 복구
Switch(config)# interface fa0/1
Switch(config-if)# shutdown
Switch(config-if)# no shutdown

! 자동 복구 설정 (300초 후 재시도)
Switch(config)# errdisable recovery cause bpduguard
Switch(config)# errdisable recovery interval 300
```

---

## 5. 보안 고려사항

*   **PortFast + BPDU Guard 필수 조합**: 사용자 포트에 PortFast를 설정할 때는 반드시 BPDU Guard를 함께 활성화하여 악의적인 스위치 연결(Rogue Switch)을 차단한다.
*   **Root Guard**: 특정 포트로 들어온 BPDU가 현재 Root보다 우월한 BID를 가지면 해당 포트를 차단한다. 비인가 스위치가 Root를 탈취하는 것을 방지한다.
    ```cisco
    Switch(config-if)# spanning-tree guard root
    ```
*   **Loop Guard**: BPDU 수신이 갑자기 중단되어도 Blocking 상태를 Forwarding으로 전환하지 않아 루프 발생을 막는다.
*   **미사용 포트 Shutdown**: 연결되지 않은 포트는 `shutdown`하여 물리적 공격 표면을 줄인다.

<hr class="short-rule">
